# 网格分析公式对照表

## 1. 基础网格指标（后端）

| 指标 | 公式 | 说明 | 代码位置 |
|---|---|---|---|
| 网格内 POI 数 | `poi_count = N(cell)` | 统计落入当前 H3 网格的 POI 数量 | `modules/grid_h3/analysis.py` `aggregate_pois_to_h3` |
| 网格密度 | `density = poi_count / area_km2` | 单位：`POI/km²` | `modules/grid_h3/analysis.py` `compute_cell_metrics` |
| 局部熵（原始） | `H = -Σ(p_i * ln p_i)` | `p_i` 为 7 大类在该格内占比 | `modules/grid_h3/analysis.py` `_shannon_entropy` |
| 邻域平均密度 | `neighbor_mean_density = mean(density_neighbors)` | 邻域默认 `ring=1` | `modules/grid_h3/analysis.py` `compute_neighbor_metrics` |
| 邻域平均熵 | `neighbor_mean_entropy = mean(entropy_neighbors)` | 邻域默认 `ring=1` | `modules/grid_h3/analysis.py` `compute_neighbor_metrics` |

## 2. 显著性检验（后端，PySAL）

| 指标 | 公式/方法 | 说明 | 代码位置 |
|---|---|---|---|
| 全局莫兰指数 | `Moran's I`（PySAL `Moran`） | 全局空间自相关 | `modules/grid_h3/analysis.py` `compute_global_moran_significance` |
| 全局显著性 p | `p_sim`（置换检验） | `permutations=4999` 时最小 p 约 `1/5000` | `modules/grid_h3/analysis.py` `compute_global_moran_significance` |
| 局部莫兰（LISA） | `Moran_Local` | 输出 `lisa_i / lisa_p / lisa_cluster(HH,HL,LH,LL)` | `modules/grid_h3/analysis.py` `compute_local_spatial_significance` |
| Gi* | `G_Local` | 输出 `gi_star_z_score / gi_star_p_value / hotspot/coldspot` | `modules/grid_h3/analysis.py` `compute_local_spatial_significance` |
| FDR 校正 | Benjamini-Hochberg | 对局部 p 值做多重检验校正（可开关） | `modules/grid_h3/analysis.py` `_build_fdr_mask` |
| 显著网格判定 | `is_significant = lisa_significant OR gi_star_significant` | 任一通过即记为显著 | `modules/grid_h3/analysis.py` `compute_local_spatial_significance` |

## 3. 地图指标（前端）

| 指标 | 公式 | 说明 | 代码位置 |
|---|---|---|---|
| 密度 | `density = density_poi_per_km2` | 直接使用后端字段 | `templates/analysis.html` `_getH3MetricValue` |
| 局部熵（归一化） | `H' = H / ln(7)` | 限制到 `[0,1]`；样本过少时设无数据 | `templates/analysis.html` `_getH3MetricValue` |
| 邻域差值 | `neighbor_delta = density - neighbor_mean_density` | 正值表示高于邻域 | `templates/analysis.html` `_getH3MetricValue` |

## 4. 网格分型（前端）

| 项 | 规则 | 说明 | 代码位置 |
|---|---|---|---|
| 高低阈值 | `density P70`、`entropy P70` | 按当前批次分位数取阈值 | `templates/analysis.html` `computeH3DerivedStats` |
| 四象限分型 | 高密高混合 / 高密低混合 / 低密高混合 / 低密低混合 | 用于结构识别 | `templates/analysis.html` `classifyGridType` |
| 机会标记 | `is_opportunity = (高密高混合) AND (neighbor_delta > 0)` | 用于机会优先级 | `templates/analysis.html` `classifyGridType` |

## 5. LQ（相对优势，前端）

| 指标 | 公式 | 说明 | 代码位置 |
|---|---|---|---|
| 全局占比 | `global_share[c] = (gCount + α) / (globalTotal + α*K)` | `K` 为类别数，`α` 为平滑参数 | `templates/analysis.html` `computeCellLQ` |
| 单格占比 | `cell_share[c] = (cCount + α) / (poiCount + α*K)` | 避免小样本占比极端 | `templates/analysis.html` `computeCellLQ` |
| LQ | `LQ[c] = cell_share[c] / global_share[c]` | `>1` 通常表示相对优势 | `templates/analysis.html` `computeCellLQ` |

## 6. 缺口评分（前端）

| 指标 | 公式 | 说明 | 代码位置 |
|---|---|---|---|
| 类别密度 | `density_by_cat[k] = density * (count_k / poi_count)` | 将总密度按类别拆分 | `templates/analysis.html` `computeGapScore` |
| 需求代理 | `demand_proxy = 0.4*transport + 0.25*life + 0.2*education + 0.15*medical` | 权重可在前端调整 | `templates/analysis.html` `computeGapScore` |
| 供给代理 | `supply_target = density_by_cat[target]` | 目标业态供给强度 | `templates/analysis.html` `computeGapScore` |
| 百分位缺口 | `gap_score = demand_pct - supply_pct` | 值越大代表“需求相对高、供给相对弱” | `templates/analysis.html` `computeH3DerivedStats` |

## 7. 当前默认参数（代码实现）

| 参数 | 默认值 | 位置 |
|---|---|---|
| H3 分辨率 | `10` | `templates/analysis.html` |
| 邻域 ring | `1` | `modules/grid_h3/analysis_schemas.py` |
| 显著性置换次数 | `4999` | `modules/grid_h3/analysis_schemas.py` |
| 显著性阈值 | `alpha=0.05`（前端 95% 转换） | `templates/analysis.html` `computeH3Analysis` |
| FDR 默认 | `false` | `modules/grid_h3/analysis_schemas.py` / `templates/analysis.html` |
| 熵最小样本阈值 | `poi_count < 3` 视为无数据 | `templates/analysis.html` `h3EntropyMinPoi` |

## 8. 口径说明

1. 当前“显著性”是探索口径：默认关闭 FDR，便于观察空间结构。
2. 若用于报告，建议开启 FDR，并在文档中固定置换次数、置信度、研究范围。
3. 前端 `confidence`（高/中/低）是样本量提示，不是统计显著性结论。

